<!DOCTYPE html>
<html>
<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="../dist/mapbox-gl.css" />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
    </style>
</head>

<body>
<div id="map"></div>

<script src="../dist/mapbox-gl-dev.js"></script>
<script type="module">
import {Pane} from 'https://esm.sh/tweakpane@4';
import {getAccessToken} from './access_token_generated.js';

mapboxgl.accessToken = getAccessToken();

var map = window.map = new mapboxgl.Map({
    container: 'map',
    zoom: 12.5,
    center: [-77.01866, 38.888],
    style: 'mapbox://styles/mapbox/streets-v12',
    projection: 'globe',
    hash: true
});

const features = [];
const spinningMarkers = [];
['auto', 'map', 'viewport', 'horizon'].forEach((rotationAlignment, i) => {
    ['auto', 'map', 'viewport'].forEach((pitchAlignment, j) => {
        const bounds = map.getBounds();
        const s = bounds.getSouth();
        const n = bounds.getNorth();
        const w = bounds.getWest();
        const e = bounds.getEast();

        const lng = w + (e - w) * ((i + .5) / 4);
        const lat = s + (n - s) * ((j + .5) / 3);
        const altitude = (i * 2000 + j*2000) * (e - w);

        const popup = new mapboxgl.Popup().setHTML(`
            Pitch Alignment: ${pitchAlignment}<br aria-hidden="true">
            Rotation Alignment: ${rotationAlignment}<br aria-hidden="true">
            Altitude: ${altitude.toFixed(0)} meters
        `);

        const r = Math.round(Math.random() * 255);
        const g = Math.round(Math.random() * 255);
        const b = Math.round(Math.random() * 255);
        const color = `rgb(${r}, ${g}, ${b})`;

        const sc = Math.random() * 2.5 + 0.5;

        const marker = new mapboxgl.Marker({
            color,
            scale: sc,
            draggable: true,
            rotationAlignment,
            pitchAlignment,
            altitude
        })
            .setLngLat([lng, lat])
            .setPopup(popup)
            .addTo(map);

        marker.togglePopup();

        spinningMarkers.push(marker);

        const lngOffset = (e - w)/100;
        const latOffset = (n - s)/100;

        features.push({
            type: 'Feature',
            geometry: {
                type: 'Polygon',
                coordinates: [
                    [
                        [lng-lngOffset,lat+latOffset],
                        [lng+lngOffset,lat+latOffset],
                        [lng+lngOffset,lat-latOffset],
                        [lng-lngOffset,lat-latOffset],
                        [lng-lngOffset,lat+latOffset],
                    ]
                ]
            },
            properties: {altitude, color}
        });
    });
});

map.on('style.load',() => {
    map.setBearing(50);
    map.setPitch(70);

    map.addSource('fill-extrusions', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: features
        }
    });

    map.addLayer({
        id: 'fill-extrusions',
        type: 'fill-extrusion',
        source: 'fill-extrusions',
        paint: {
            'fill-extrusion-opacity': 0.6,
            'fill-extrusion-color': ['get', 'color'],
            'fill-extrusion-height': ['get', 'altitude'],
            'fill-extrusion-base': 0,
            'fill-extrusion-base-alignment': 'terrain'
        }
    });
})

const pane = new Pane();
pane.addBinding({terrain: false}, 'terrain').on('change', (e) => {
    map.setTerrain(e.value ? {"source": "mapbox-dem", "exaggeration": 10} : null);
});

let animate = false;
pane.addBinding({animate: false}, 'animate').on('change', (e) => {
    animate = !animate;
    if (animate) {
        spinMarkers();
    }
});

let rotation = 0;
function spinMarkers() {
    rotation++;
    spinningMarkers.forEach((marker) => {
        marker.setRotation(rotation);
    });
    if (animate) {
        window.requestAnimationFrame(spinMarkers);
    }
}
window.requestAnimationFrame(spinMarkers);

map.on('style.load', function() {
    map.addSource('mapbox-dem', {
        "type": "raster-dem",
        "url": "mapbox://mapbox.mapbox-terrain-dem-v1",
        "tileSize": 512,
        "maxzoom": 14
    });
});

</script>
</body>
</html>
